<% @server['upstreams'].each do |upstream_name, upstream_def| %>
upstream <%= upstream_name %> {
    server <%= upstream_def['ip'] %>:<%= upstream_def['port'] || 80 %>;
}

<% end if @server['upstreams'] %>
server {
    listen *:<%= @server['port'] || 80 %>;
    server_name <%= @server_name %>;
    server_tokens off;
<% if @server['root'] %>    root <%= @server['root'] %>;<% end %>

<% @server['locations'].each do |location_def| %>
    location <%= location_def['path'] %> {
        proxy_pass http://<%= location_def['upstream'] %><%= location_def['alias'] %>/;
        proxy_redirect http://<%= location_def['upstream'] %><%= location_def['alias'] %>/ <%= location_def['alias'] %>/;
        proxy_set_header Host $proxy_host;
        proxy_set_header X-Real-IP $remote_addr;
    }

<% end if @server['locations'] %>
}
